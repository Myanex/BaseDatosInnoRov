<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Gesti√≥n ROV</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#111821; --muted:#2a394a; --ink:#e6eef7; --accent:#82cfff; --ok:#35c759; --warn:#ffb020; --err:#ff5a52; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,var(--bg),#0e141c 40%, var(--bg)); color:var(--ink); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky; top:0; z-index:10; background:rgba(17,24,33,.9); backdrop-filter:blur(6px);
      border-bottom:1px solid var(--muted); padding:14px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between}
    .title-left{font-weight:700; font-size:1.3em; letter-spacing:.2px}
    input,button{background:#0f1722; color:var(--ink); border:1px solid var(--muted); border-radius:10px; padding:8px 10px; outline:none}
    button{cursor:pointer} button:disabled{opacity:.65; cursor:not-allowed}
    main{ max-width:1200px; margin:16px auto; padding:0 12px; }
    .tabs{ display:flex; gap:8px; border-bottom:1px solid var(--muted); margin-bottom:12px; flex-wrap:wrap }
    .tab-btn{ padding:10px 12px; border:1px solid var(--muted); border-bottom:none; border-radius:10px 10px 0 0; background:#0f1722; color:var(--ink); cursor:pointer }
    .tab-btn.active{ background:#122235; border-color:var(--accent) }
    .tab{ display:none; border:1px solid var(--muted); border-radius:0 10px 10px 10px; padding:12px; background:#0f1722; position:relative; overflow:auto }
    .tab.active{ display:block }
    table{ width:100%; border-collapse:collapse; font-size:13px }
    th, td{ padding:8px 10px; border-bottom:1px solid #1e2a38; text-align:left; white-space:nowrap }
    th{ position:sticky; top:0; background:#0f1722; z-index:1; font-weight:600 }
    tr:hover{ background:#111f2f }
    .controls{ display:flex; align-items:center; gap:8px; margin:8px 0 12px 0; flex-wrap:wrap }
    .spinner{ position:absolute; inset:0; display:none; place-items:center; background:rgba(10,15,22,.55); backdrop-filter:blur(2px) }
    .spinner.active{ display:grid } .spinner .dot{ width:12px; height:12px; border-radius:50%; background:var(--accent); animation:pulse .9s infinite alternate }
    @keyframes pulse{ to{ transform:scale(1.8); opacity:.5 } }
    .toast-wrap{ position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:100 }
    .toast{ background:#0f1722; border:1px solid var(--muted); padding:10px 12px; border-radius:10px; max-width:360px; box-shadow:0 10px 30px rgba(0,0,0,.35); font-size:13px }
    .toast.ok{ border-color:var(--ok) } .toast.warn{ border-color:var(--warn) } .toast.err{ border-color:var(--err) }
    .login-wrap{min-height:100dvh; display:grid; place-items:center; padding:24px}
    .card{ width:100%; max-width:380px; background:#0f1722; border:1px solid var(--muted); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35) }
    .card h1{ margin:6px 0 2px; font-size:18px }
    .row{ display:flex; flex-direction:column; gap:6px; margin:10px 0 }
    .hint{ font-size:12px; color:#9fb3c8 }
    .footnote{ color:#9fb3c8; font-size:12px; margin-top:6px }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginView" class="login-wrap">
    <div class="card">
      <h1>Iniciar sesi√≥n</h1>
      <!-- <p class="hint">RLS seg√∫n <code>profiles.role</code> y <code>profiles.centro_id</code>.</p> -->
      <div class="row">
        <label>Email</label>
        <input id="email" type="email" placeholder="usuario@dominio.com" autocomplete="username">
      </div>
      <div class="row">
        <label>Contrase√±a</label>
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <div class="row" style="gap:8px; flex-direction:row; justify-content:space-between">
        <button id="btnLogin" style="flex:1">Entrar</button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="appView" style="display:none">
    <header>
      <div class="title-left" id="page-title">Perfil</div>
      <div class="right">
        <button id="btnReload">Recargar pesta√±a</button>
        <button id="btnSignOut">Cerrar sesi√≥n</button>
      </div>
    </header>

    <main>
      <nav class="tabs" role="tablist" aria-label="Secciones">
        <button class="tab-btn active" data-tab="inventario">Inventario</button>
        <button class="tab-btn" data-tab="pilotos">Pilotos</button>
        <button class="tab-btn" data-tab="bitacora">Bit√°cora</button>
      </nav>

      <!-- Inventario -->
      <section id="tab-inventario" class="tab active" role="tabpanel">
        <div class="spinner" id="spin-inventario" aria-hidden="true"><div class="dot"></div></div>
        <div class="controls">
          <div class="footnote">Fuente: <code id="src-inventario"></code></div>
        </div>
        <div class="table-wrap">
          <table id="tbl-inventario"><thead></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Pilotos -->
      <section id="tab-pilotos" class="tab" role="tabpanel">
        <div class="spinner" id="spin-pilotos" aria-hidden="true"><div class="dot"></div></div>
        <div class="controls">
          <div class="footnote">Fuente: <code id="src-pilotos"></code></div>
        </div>
        <div class="table-wrap">
          <table id="tbl-pilotos"><thead></thead><tbody></tbody></table>
        </div>
      </section>

      <!-- Bit√°cora -->
      <section id="tab-bitacora" class="tab" role="tabpanel">
        <div class="spinner" id="spin-bitacora" aria-hidden="true"><div class="dot"></div></div>
        <div class="controls">
          <div class="footnote">Fuente: <code id="src-bitacora"></code></div>
        </div>
        <div class="table-wrap">
          <table id="tbl-bitacora"><thead></thead><tbody></tbody></table>
        </div>
      </section>
    </main>
  </div>

  <div class="toast-wrap" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // üîê CREDENCIALES SUPABASE ‚Äî‚Äî‚Äî‚Äî
    const SUPABASE_URL = "https://hvcbgphnrlbtihldohov.supabase.co"; // ej: https://hvcbgphnrlbtihldohov.supabase.co
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2Y2JncGhucmxidGlobGRvaG92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NzU1MzcsImV4cCI6MjA3MDQ1MTUzN30.EVGqWmhb_vMv4vAC-NqlfnyeubCD8T5DJH5PcryYFUc";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Utilidades UI =====
    const $ = (s)=>document.querySelector(s), $$=(s)=>document.querySelectorAll(s);
    const toasts=$("#toasts");
    function toast(msg,type="ok",t=4200){ const el=document.createElement("div"); el.className=`toast ${type}`; el.textContent=msg; toasts.appendChild(el); setTimeout(()=>el.remove(),t); }
    function spin(tab,on){ const sp=$(`#spin-${tab}`); if(sp){ sp.classList.toggle("active",!!on); sp.setAttribute("aria-hidden", on? "false":"true"); } }
    const escapeHtml = (s)=> String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

    // ===== Estado global =====
    let session=null, profile=null;

    // Cat√°logos (cache)
    const catalogs = {
      centros: new Map(),
      tipo_componente: new Map(),
      estado_componente: new Map(),
      estado_puerto: new Map(),
      actividad: new Map(),
      pilotos: new Map(),
    };

    // === Helpers ===
    const fmtDateDMY = (iso)=>{
      if(!iso) return "";
      const d = new Date(iso);
      if (isNaN(d)) return String(iso);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    };
    const fmtRUT = (rut)=>{
      if(!rut) return "";
      const clean = String(rut).replace(/[^\dkK]/g,"").toUpperCase();
      if(clean.length < 2) return rut;
      const cuerpo = clean.slice(0, -1);
      const dv = clean.slice(-1);
      const withDots = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      return `${withDots}-${dv}`;
    };
    const nameFrom = (catalog, id)=> catalogs[catalog]?.get?.(id) ?? id ?? "";

    async function loadCatalog(table, idField="id", textField="nombre"){
      const { data, error } = await supabase.from(table).select(`${idField}, ${textField}`).limit(10000);
      if(error) throw error;
      const map = new Map();
      for(const row of data||[]) map.set(row[idField], row[textField]);
      return map;
    }
    async function loadCatalogs(role){
      catalogs.centros.clear();
      catalogs.tipo_componente.clear();
      catalogs.estado_componente.clear();
      catalogs.estado_puerto.clear();
      catalogs.actividad.clear();
      catalogs.pilotos.clear();

      catalogs.centros = await loadCatalog("centros");
      catalogs.tipo_componente = await loadCatalog("tipo_componente");
      catalogs.estado_componente = await loadCatalog("estado_componente");
      catalogs.estado_puerto = await loadCatalog("estado_puerto");
      catalogs.actividad = await loadCatalog("actividad_catalogo");

      if(role === "centro"){
        try{
          const { data, error } = await supabase.from("v_pilotos_centro").select("id, nombre").limit(10000);
          if(!error && data?.length){
            const m = new Map();
            for(const r of data) m.set(r.id, r.nombre);
            catalogs.pilotos = m;
          }
        }catch{/* noop */}
      }else{
        try{
          catalogs.pilotos = await loadCatalog("pilotos");
        }catch{/* noop */}
      }
    }

    function sourcesByRole(role){
      if(role === "oficina"){
        return {
          inventario: { from:"v_componentes_oficina", select:"*" },
          pilotos:    { from:"pilotos",     select:"nombre, rut, centro_id" },
          bitacora:   { from:"bitacoras",   select:"fecha, centro_id, piloto_id, estado_puerto_id, actividad_id" },
        };
      }
      return {
        inventario: { from:"v_componentes_centro", select:"*" },
        pilotos:    { from:"v_pilotos_centro",     select:"*" },
        bitacora:   { from:"v_bitacoras_centro",   select:"*" },
      };
    }
    function paintSources(role){
      const srcs = sourcesByRole(role);
      $("#src-inventario").textContent = srcs.inventario.from;
      $("#src-pilotos").textContent    = srcs.pilotos.from;
      $("#src-bitacora").textContent   = srcs.bitacora.from;
    }

    // ===== Presenters =====
    function presentInventario(row){
      const codigo = row.codigo ?? "";
      const serie  = row.serie ?? "";
      const tipoTxt =
        row.tipo_componente?.nombre ||
        row.tipo_componente_nombre  ||
        row.tipo ||
        nameFrom("tipo_componente", row.tipo_componente_id);
      const estadoTxt =
        row.estado_componente?.nombre ||
        row.estado_componente_nombre  ||
        row.estado ||
        nameFrom("estado_componente", row.estado_componente_id);

      let ubicacion =
        row.ubicacion ||
        row.centro_nombre ||
        row.nombre_centro ||
        row.centros?.nombre ||
        (row.centro_id ? nameFrom("centros", row.centro_id) : "");

      if((!ubicacion || ubicacion === "null" || ubicacion === "undefined") && (profile?.role === "centro")){
        ubicacion = catalogs.centros.get(profile?.centro_id) || "";
      }
      if(!ubicacion) ubicacion = "‚Äî";

      return [codigo, tipoTxt, serie, estadoTxt, ubicacion];
    }

    function presentPilotos(row){
      const nombre = row.nombre ?? row.piloto_nombre ?? "";
      const rut    = fmtRUT(row.rut ?? row.piloto_rut ?? "");
      const ubicacion =
        row.centros?.nombre ??
        row.centro ??
        row.centro_nombre ??
        nameFrom("centros", row.centro_id);
      return [nombre, rut, ubicacion];
    }

    function presentBitacora(row){
      const fecha = fmtDateDMY(row.fecha ?? row.fecha_bitacora ?? row.created_at);
      const centro =
        row.centros?.nombre ??
        row.centro ??
        row.centro_nombre ??
        nameFrom("centros", row.centro_id);
      const piloto =
        row.pilotos?.nombre ??
        row.piloto ??
        row.piloto_nombre ??
        nameFrom("pilotos", row.piloto_id);
      const estadoPuerto =
        row.estado_puerto?.nombre ??
        row.estado_puerto_texto ??
        nameFrom("estado_puerto", row.estado_puerto_id);
      const actividad =
        row.actividad_catalogo?.nombre ??
        row.actividad ??
        row.actividad_texto ??
        nameFrom("actividad", row.actividad_id);
      return [fecha, centro, piloto, estadoPuerto, actividad];
    }

    function renderTableWithColumns(tableId, headers, rows){
      const thead = document.querySelector(`#${tableId} thead`);
      const tbody = document.querySelector(`#${tableId} tbody`);
      thead.innerHTML=""; tbody.innerHTML="";
      if(!rows?.length){ thead.innerHTML="<tr><th>Sin datos</th></tr>"; return; }
      thead.innerHTML = `<tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr>`;
      const frag = document.createDocumentFragment();
      rows.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML = r.map(c=>`<td>${escapeHtml(String(c ?? ""))}</td>`).join("");
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    // ===== Auth / Perfil =====
    async function getProfile(){
      const { data: { user } } = await supabase.auth.getUser();
      if(!user) return null;
      const { data, error } = await supabase
        .from("profiles")
        .select("id, role, centro_id")
        .eq("id", user.id)
        .maybeSingle();
      if(error){ toast("No se pudo leer profiles: "+error.message, "err"); return null; }
      if(!data){ toast("El usuario no tiene fila en profiles.", "err"); return null; }
      return { user, ...data };
    }
    async function signIn(email, password){
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) throw error;
      session = data.session;
      profile = await getProfile();
      await loadCatalogs(profile?.role || "centro");
      return { session, profile };
    }
    async function signOut(){
      await supabase.auth.signOut();
      session=null; profile=null;
      Object.values(catalogs).forEach(m => m.clear && m.clear());
    }

    function setHeaderTitle(){
      const el = $("#page-title");
      if(profile?.role === "oficina"){
        el.textContent = "Perfil: Oficina";
      } else if(profile?.role === "centro"){
        const centroNombre = catalogs.centros.get(profile?.centro_id) || "";
        el.textContent = `Perfil: Centro ‚Äì ${centroNombre}`;
      } else {
        el.textContent = "Perfil";
      }
    }

    async function loadTab(tab){
      try{
        spin(tab,true);
        const role = (profile?.role || "centro");
        const src = sourcesByRole(role)[tab];

        await loadCatalogs(role);
        setHeaderTitle();
        paintSources(role);

        const { data, error } = await supabase.from(src.from).select(src.select).limit(1000);
        if(error) throw error;

        if(tab === "inventario"){
          const headers = ["C√≥digo","Tipo","Serie","Estado","Ubicaci√≥n"];
          const rows = (data||[]).map(presentInventario);
          renderTableWithColumns("tbl-inventario", headers, rows);
        }else if(tab === "pilotos"){
          const headers = ["Piloto","RUT","Ubicaci√≥n"];
          const rows = (data||[]).map(presentPilotos);
          renderTableWithColumns("tbl-pilotos", headers, rows);
        }else if(tab === "bitacora"){
          const headers = ["Fecha","Centro","Piloto","Estado Puerto","Actividad"];
          const rows = (data||[]).map(presentBitacora);
          renderTableWithColumns("tbl-bitacora", headers, rows);
        }
      }catch(err){
        console.error(err);
        toast(`Error cargando ${tab}: ${err.message || err}`, "err");
      }finally{ spin(tab,false); }
    }

    // ===== UI events =====
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.querySelectorAll(".tab").forEach(p=>p.classList.remove("active"));
        document.getElementById(`tab-${tab}`).classList.add("active");
        loadTab(tab);
      });
    });
    document.getElementById("btnReload").addEventListener("click", ()=>{
      const active = document.querySelector(".tab-btn.active")?.dataset.tab || "inventario";
      loadTab(active);
    });
    document.getElementById("btnSignOut").addEventListener("click", async ()=>{
      await signOut(); toast("Sesi√≥n cerrada","ok"); enterLogin();
    });
    document.getElementById("btnLogin").addEventListener("click", async ()=>{
      const email=document.getElementById("email").value.trim(), password=document.getElementById("password").value;
      if(!email || !password){ toast("Completa email y contrase√±a","warn"); return; }
      try{
        await signIn(email, password);
        toast("¬°Bienvenido!","ok");
        enterApp();
      }catch(err){
        console.error(err);
        toast("Login fallido: "+(err.message || err),"err");
      }
    });

    function enterLogin(){ $("#loginView").style.display="grid"; $("#appView").style.display="none"; }
    function enterApp(){
      $("#loginView").style.display="none";
      $("#appView").style.display="block";
      setHeaderTitle();
      const role = (profile?.role || "centro");
      paintSources(role);
      loadTab("inventario");
    }

    // ===== Arranque =====
    (async ()=>{
      const { data } = await supabase.auth.getSession();
      session = data.session;
      profile = await getProfile();
      const role = (profile?.role || "centro");
      await loadCatalogs(role);
      if(session && profile) enterApp(); else enterLogin();
    })();
  </script>
</body>
</html>
