<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión ROV — V3</title>
  <style>
    :root{color-scheme:dark light}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#0b1220;color:#e5e7eb;border-bottom:1px solid #1f2937}
    header .session{font-size:.9rem;color:#9ca3af}
    header .session strong{color:#e5e7eb}
    main{padding:12px}
    .hidden{display:none}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tabs button{padding:8px 10px;border-radius:8px;border:1px solid #374151;background:#111827;color:#e5e7eb;cursor:pointer}
    .tabs button.active{background:#2563eb;border-color:#2563eb}
    .card{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2937;padding:8px;text-align:left;font-size:.95rem}
    .acciones{display:flex;gap:8px}
    .btn{border:none;border-radius:8px;padding:6px 10px;cursor:pointer}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-secondary{background:#374151;color:#fff}
    .muted{color:#9ca3af;font-size:.9rem}

    /* Modal mínimo */
    .modal.hidden{display:none}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:50}
    .modal-content{background:#111827;color:#e5e7eb;max-width:520px;width:92%;padding:16px;border-radius:12px;border:1px solid #1f2937}
    .modal-content h3{margin:0 0 6px}
    .modal-content label{display:block;margin:12px 0 4px;font-size:.9rem;color:#9ca3af}
    .modal-content select,.modal-content textarea{width:100%;background:#0b1220;color:#e5e7eb;border:1px solid #374151;border-radius:8px;padding:8px}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .danger{color:#ef4444}
    .ok{color:#10b981}
  </style>

  <!-- Config y cliente Supabase (deben existir en tu proyecto) -->
  <script src="./env.js"></script>
  <script src="./js/supabaseClient.js"></script>
  <script src="./js/auth.js"></script>
  <script src="./js/main.js" defer></script>
  <!-- Páginas/feature -->
  <script src="./js/equipos.js" defer></script>
  <script src="./js/componentes.js" defer></script>
</head>
<body>

  <!-- Header (se muestra solo logeado) -->
  <header id="appHeader" class="hidden">
    <div>
      <div><strong>Gestión ROV — V3</strong></div>
      <div class="session">
        <span id="hdrEmail">—</span> · Rol: <span id="hdrRol">—</span> · Centro: <span id="hdrCentro">—</span>
      </div>
    </div>
    <div>
      <button id="btnLogout" class="btn btn-secondary">Salir</button>
    </div>
  </header>

  <main>
    <!-- Vista Login -->
    <section id="view-login" class="card">
      <h2>Ingresar</h2>
      <p class="muted">Email y contraseña de tu cuenta Supabase Auth.</p>
      <div style="display:grid;gap:8px;max-width:360px">
        <label>Email
          <input id="loginEmail" type="email" placeholder="tu@correo.com"
                 style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:#e5e7eb" />
        </label>
        <label>Contraseña
          <input id="loginPassword" type="password" placeholder="••••••••"
                 style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#0b1220;color:#e5e7eb" />
        </label>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnLogin" class="btn btn-primary">Entrar</button>
          <span id="loginMsg" class="muted"></span>
        </div>
      </div>
    </section>

    <!-- Vista App -->
    <section id="view-app" class="hidden">
      <div class="tabs">
        <button id="tabEquipos" class="active">Equipos</button>
        <button id="tabComponentes">Componentes</button>
      </div>

      <!-- Página: Equipos -->
      <section id="page-equipos" class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <h2 style="margin:0">Equipos</h2>
          <div class="muted" id="equiposInfo">—</div>
        </div>
        <div class="muted" style="margin-bottom:8px">
          Verás solo los equipos asignados a tu centro (RLS) o todos si eres super-rol.
        </div>
        <div style="overflow:auto">
          <table id="tblEquipos">
            <thead>
              <tr>
                <th style="width:160px">Código</th>
                <th>Descripción</th>
                <th style="width:160px">Componentes (ensamblados)</th>
                <th style="width:220px">Acciones</th>
              </tr>
            </thead>
            <tbody id="tblEquiposBody">
              <!-- filas dinámicas -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- Página: Componentes (placeholder para mantener compatibilidad) -->
      <section id="page-componentes" class="card hidden">
        <h2 style="margin-top:0">Componentes</h2>
        <p class="muted">Vista en construcción (usa la pestaña Equipos para “Reportar falla”).</p>
      </section>
    </section>
  </main>

  <!-- Modal: Reportar falla (Equipo → Componente ensamblado) -->
  <div id="modalFallaEquipo" class="modal hidden" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalFallaEquipoTitle">
      <h3 id="modalFallaEquipoTitle">Reportar falla</h3>
      <p class="muted" id="fallaEquipoTitulo">Equipo: —</p>

      <label for="fallaEquipoComponente">Componente ensamblado</label>
      <select id="fallaEquipoComponente"></select>

      <label for="fallaEquipoDetalle">Detalle</label>
      <textarea id="fallaEquipoDetalle" rows="4" placeholder="Describe la falla..."></textarea>

      <div class="modal-actions">
        <button id="btnFallaEquipoCancelar" class="btn btn-secondary">Cancelar</button>
        <button id="btnFallaEquipoEnviar" class="btn btn-primary">Reportar</button>
      </div>
    </div>
  </div>

  <script>
    // Navegación simple de tabs (sin depender de main.js)
    document.addEventListener('DOMContentLoaded', () => {
      const $tabEq = document.getElementById('tabEquipos');
      const $tabCo = document.getElementById('tabComponentes');
      const $pgEq  = document.getElementById('page-equipos');
      const $pgCo  = document.getElementById('page-componentes');

      function activate(tab){
        if(tab==='equipos'){
          $tabEq.classList.add('active'); $tabCo.classList.remove('active');
          $pgEq.classList.remove('hidden'); $pgCo.classList.add('hidden');
        }else{
          $tabCo.classList.add('active'); $tabEq.classList.remove('active');
          $pgCo.classList.remove('hidden'); $pgEq.classList.add('hidden');
        }
      }
      $tabEq?.addEventListener('click', () => activate('equipos'));
      $tabCo?.addEventListener('click', () => activate('componentes'));
    });
  </script>
</body>
</html>

